<html lang="zh-TW">
 <head>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ˆæ¡ˆæ™‚é–“è»¸ç®¡ç†</title>
  <script src="/_sdk/data_sdk.js" onerror="this.removeAttribute('src')"></script>
  <script src="/_sdk/element_sdk.js" onerror="this.removeAttribute('src')"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      width: 100%;
    }
    
    .timeline-container {
      width: 100%;
      padding: 40px 30px;
      min-height: 100%;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }
    
    .header h1 {
      font-size: 48px;
      margin: 0 0 10px 0;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .header .year {
      font-size: 32px;
      opacity: 0.9;
      font-weight: 300;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 5px 15px;
      border-radius: 8px;
      transition: background 0.3s;
    }
    
    .header .year:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .year-selector {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 2500;
      min-width: 300px;
    }
    
    .year-selector.active {
      display: block;
    }
    
    .year-selector h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 20px;
    }
    
    .year-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .year-option {
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .year-option:hover {
      border-color: #667eea;
      background: #f0f0f0;
    }
    
    .year-option.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }
    
    .timeline-wrapper {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .months-header {
      display: grid;
      grid-template-columns: 150px repeat(12, 1fr);
      gap: 5px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .month-label {
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      color: #555;
      padding: 10px 5px;
      border-right: 1px solid #e8e8e8;
    }
    
    .month-label:nth-child(7) {
      border-right: 2px solid #d0d0d0;
    }
    
    .month-label:last-child {
      border-right: none;
    }
    
    .category-label {
      font-weight: 700;
      color: #333;
      padding: 10px;
      font-size: 15px;
    }
    
    .tasks-grid {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .task-row {
      display: grid;
      grid-template-columns: 150px repeat(12, 1fr);
      gap: 5px;
      align-items: center;
      min-height: 50px;
      position: relative;
    }
    
    .task-row.dragging-row {
      opacity: 0.4;
    }
    
    .task-row.drag-over-row {
      border-top: 3px solid #667eea;
      padding-top: 3px;
    }
    
    .task-name {
      font-weight: 500;
      color: #333;
      padding: 10px;
      font-size: 14px;
      word-wrap: break-word;
      cursor: move;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .task-name::before {
      content: 'â˜°';
      color: #999;
      font-size: 16px;
    }
    
    .timeline-grid {
      display: contents;
    }
    
    .task-bar {
      height: 40px;
      border-radius: 8px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      user-select: none;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .task-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    
    .task-bar.dragging {
      opacity: 0.5;
      cursor: grabbing;
      z-index: 1000;
    }
    
    .drop-zone {
      min-height: 40px;
      transition: background 0.2s;
      border-right: 1px solid #f0f0f0;
    }
    
    .drop-zone:nth-child(7) {
      border-right: 2px solid #d0d0d0;
    }
    
    .drop-zone:last-child {
      border-right: none;
    }
    
    .drop-zone.drag-over {
      background: #dbeafe !important;
      border: 2px dashed #3b82f6;
      border-radius: 8px;
    }
    
    .controls {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content h2 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .color-options {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    
    .color-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.selected {
      border-color: #333;
      transform: scale(1.15);
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    
    .modal-actions .btn {
      flex: 1;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-size: 16px;
    }
    
    .loading.active {
      display: block;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .delete-confirm {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 3000;
      display: none;
    }
    
    .delete-confirm.active {
      display: block;
    }
    
    .delete-confirm p {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #333;
    }
    
    .delete-confirm-actions {
      display: flex;
      gap: 10px;
    }
    
    .offline-notice {
      background: #fef3c7;
      color: #92400e;
      padding: 10px 20px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .usage-hint {
      background: #f0f9ff;
      color: #0c4a6e;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="timeline-container">
   <div class="header">
    <h1 id="timeline-title">å°ˆæ¡ˆæ™‚é–“è»¸</h1>
    <div class="year" id="year-label" onclick="openYearSelector()">
     2025 â–¼
    </div>
   </div>
   <div class="timeline-wrapper">
    <div id="offline-notice" class="offline-notice" style="display:none;">
     ğŸ“± é›¢ç·šæ¨¡å¼ï¼šè³‡æ–™å„²å­˜åœ¨ç€è¦½å™¨æœ¬åœ°ï¼Œé‡æ–°æ•´ç†å¾Œæœƒä¿ç•™
    </div>
    <div class="usage-hint">
     ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong>é»æ“Šä»»å‹™æ¢å¯ç·¨è¼¯ï¼Œé»æ“Šå…©ä¸‹å¯åˆªé™¤ | æ‹–æ›³ä»»å‹™æ¢å¯èª¿æ•´æ™‚é–“ | æ‹–æ›³ä»»å‹™åˆ—å¯èª¿æ•´é †åº
    </div>
    <div class="months-header">
     <div class="category-label">
      ä»»å‹™åç¨±
     </div>
     <div class="month-label">
      1æœˆ
     </div>
     <div class="month-label">
      2æœˆ
     </div>
     <div class="month-label">
      3æœˆ
     </div>
     <div class="month-label">
      4æœˆ
     </div>
     <div class="month-label">
      5æœˆ
     </div>
     <div class="month-label">
      6æœˆ
     </div>
     <div class="month-label">
      7æœˆ
     </div>
     <div class="month-label">
      8æœˆ
     </div>
     <div class="month-label">
      9æœˆ
     </div>
     <div class="month-label">
      10æœˆ
     </div>
     <div class="month-label">
      11æœˆ
     </div>
     <div class="month-label">
      12æœˆ
     </div>
    </div>
    <div class="loading" id="loading">
     è¼‰å…¥ä¸­...
    </div>
    <div class="tasks-grid" id="tasks-grid"></div>
    <div class="controls"><button class="btn btn-primary" id="add-task-btn">â• æ–°å¢ä»»å‹™</button> <button class="btn" id="share-btn" style="background: #10b981; color: white;">ğŸ“¤ åˆ†äº«æ™‚é–“è»¸</button>
    </div>
   </div>
  </div>
  <div class="year-selector" id="year-selector">
   <h3>é¸æ“‡å¹´ä»½</h3>
   <div class="year-options" id="year-options"></div>
   <div class="modal-actions"><button class="btn" onclick="closeYearSelector()" style="background: #6b7280; color: white;">å–æ¶ˆ</button> <button class="btn btn-primary" onclick="confirmYearSelection()">ç¢ºèª</button>
   </div>
  </div>
  <div class="modal" id="task-modal">
   <div class="modal-content">
    <h2 id="modal-title">æ–°å¢ä»»å‹™</h2>
    <form id="task-form">
     <div class="form-group"><label for="task-name-input">ä»»å‹™åç¨±</label> <input type="text" id="task-name-input" required placeholder="è¼¸å…¥ä»»å‹™åç¨±">
     </div>
     <div class="form-group"><label for="start-month">é–‹å§‹æœˆä»½</label> <select id="start-month" required> <option value="1">1æœˆ</option> <option value="2">2æœˆ</option> <option value="3">3æœˆ</option> <option value="4">4æœˆ</option> <option value="5">5æœˆ</option> <option value="6">6æœˆ</option> <option value="7">7æœˆ</option> <option value="8">8æœˆ</option> <option value="9">9æœˆ</option> <option value="10">10æœˆ</option> <option value="11">11æœˆ</option> <option value="12">12æœˆ</option> </select>
     </div>
     <div class="form-group"><label for="end-month">çµæŸæœˆä»½</label> <select id="end-month" required> <option value="1">1æœˆ</option> <option value="2">2æœˆ</option> <option value="3">3æœˆ</option> <option value="4">4æœˆ</option> <option value="5">5æœˆ</option> <option value="6">6æœˆ</option> <option value="7">7æœˆ</option> <option value="8">8æœˆ</option> <option value="9">9æœˆ</option> <option value="10">10æœˆ</option> <option value="11">11æœˆ</option> <option value="12">12æœˆ</option> </select>
     </div>
     <div class="form-group"><label>é¸æ“‡é¡è‰²</label>
      <div class="color-options" id="color-options"></div>
     </div>
     <div class="form-group"><label for="category-input">é¡åˆ¥</label> <input type="text" id="category-input" placeholder="ä¾‹å¦‚ï¼šé€²è¡Œä¸­ã€æ˜å¹´è¨ˆç•«">
     </div>
     <div class="modal-actions"><button type="button" class="btn" onclick="closeModal()" style="background: #6b7280; color: white;">å–æ¶ˆ</button> <button type="submit" class="btn btn-primary">å„²å­˜</button>
     </div>
    </form>
   </div>
  </div>
  <div class="delete-confirm" id="delete-confirm">
   <p>ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ</p>
   <div class="delete-confirm-actions"><button class="btn" id="cancel-delete" style="background: #6b7280; color: white;">å–æ¶ˆ</button> <button class="btn btn-danger" id="confirm-delete">åˆªé™¤</button>
   </div>
  </div>
  <div class="modal" id="share-modal">
   <div class="modal-content">
    <h2>åˆ†äº«æ™‚é–“è»¸</h2>
    <p style="color: #666; margin-bottom: 25px;">é¸æ“‡æ‚¨è¦ä¸‹è¼‰çš„æ ¼å¼ï¼š</p>
    <div style="display: flex; flex-direction: column; gap: 15px;"><button class="btn btn-primary" id="download-png" style="display: flex; align-items: center; justify-content: center; gap: 10px;"> <span style="font-size: 24px;">ğŸ–¼ï¸</span> <span>ä¸‹è¼‰ç‚ºåœ–ç‰‡ (PNG)</span> </button> <button class="btn btn-primary" id="download-pdf" style="display: flex; align-items: center; justify-content: center; gap: 10px;"> <span style="font-size: 24px;">ğŸ“„</span> <span>ä¸‹è¼‰ç‚º PDF</span> </button>
    </div>
    <div class="modal-actions" style="margin-top: 25px;"><button class="btn" onclick="closeShareModal()" style="background: #6b7280; color: white; width: 100%;">å–æ¶ˆ</button>
    </div>
    <div id="download-loading" style="display: none; text-align: center; margin-top: 20px; color: #667eea;">
     <div style="font-size: 16px;">
      â³ ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      timeline_title: 'å°ˆæ¡ˆæ™‚é–“è»¸',
      year_label: '2025'
    };
    
    const colors = [
      '#dc2626', '#f97316', '#eab308', '#84cc16', 
      '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', 
      '#ec4899', '#fb7185', '#64748b', '#78716c'
    ];
    
    let selectedColor = colors[0];
    let currentTasks = [];
    let draggedTask = null;
    let draggedRowIndex = null;
    let taskToDelete = null;
    let selectedYear = null;
    let isOfflineMode = false;
    
    // é›¢ç·šæ¨¡å¼çš„ localStorage æ“ä½œ
    function saveTasksOffline(tasks) {
      try {
        localStorage.setItem('timeline_tasks', JSON.stringify(tasks));
      } catch (e) {
        console.error('ç„¡æ³•å„²å­˜åˆ° localStorage', e);
      }
    }
    
    function loadTasksOffline() {
      try {
        const data = localStorage.getItem('timeline_tasks');
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('ç„¡æ³•å¾ localStorage è¼‰å…¥', e);
        return [];
      }
    }
    
    function renderColorOptions() {
      const container = document.getElementById('color-options');
      container.innerHTML = colors.map((color, index) => 
        `<div class="color-option ${index === 0 ? 'selected' : ''}" 
              style="background: ${color}" 
              onclick="selectColor('${color}', this)"></div>`
      ).join('');
    }
    
    function selectColor(color, element) {
      selectedColor = color;
      document.querySelectorAll('.color-option').forEach(opt => 
        opt.classList.remove('selected')
      );
      element.classList.add('selected');
    }
    
    function openYearSelector() {
      const yearSelector = document.getElementById('year-selector');
      const yearOptions = document.getElementById('year-options');
      
      let currentYear = 2025;
      if (window.elementSdk && window.elementSdk.config) {
        currentYear = parseInt(window.elementSdk.config.year_label || defaultConfig.year_label);
      } else {
        const yearText = document.getElementById('year-label').textContent;
        currentYear = parseInt(yearText) || 2025;
      }
      
      const years = [];
      for (let i = currentYear - 2; i <= currentYear + 5; i++) {
        years.push(i);
      }
      
      yearOptions.innerHTML = years.map(year => 
        `<div class="year-option ${year === currentYear ? 'selected' : ''}" 
              onclick="selectYear(${year}, this)">${year}</div>`
      ).join('');
      
      selectedYear = currentYear;
      yearSelector.classList.add('active');
    }
    
    function closeYearSelector() {
      document.getElementById('year-selector').classList.remove('active');
    }
    
    function selectYear(year, element) {
      selectedYear = year;
      document.querySelectorAll('.year-option').forEach(opt => 
        opt.classList.remove('selected')
      );
      element.classList.add('selected');
    }
    
    async function confirmYearSelection() {
      if (selectedYear) {
        if (window.elementSdk) {
          await window.elementSdk.setConfig({ year_label: selectedYear.toString() });
        } else {
          // é›¢ï¿½ï¿½ï¿½æ¨¡ï¿½ï¿½ï¿½
          document.getElementById('year-label').textContent = selectedYear + ' â–¼';
        }
      }
      closeYearSelector();
    }
    
    function openModal(task = null) {
      const modal = document.getElementById('task-modal');
      const form = document.getElementById('task-form');
      const modalTitle = document.getElementById('modal-title');
      
      if (task) {
        modalTitle.textContent = 'ç·¨è¼¯ä»»å‹™';
        document.getElementById('task-name-input').value = task.task_name;
        document.getElementById('start-month').value = task.start_month;
        document.getElementById('end-month').value = task.end_month;
        document.getElementById('category-input').value = task.category || '';
        selectedColor = task.color;
        
        document.querySelectorAll('.color-option').forEach((opt, index) => {
          opt.classList.toggle('selected', colors[index] === task.color);
        });
        
        form.onsubmit = (e) => handleEditTask(e, task);
      } else {
        modalTitle.textContent = 'æ–°å¢ä»»å‹™';
        form.reset();
        selectedColor = colors[0];
        renderColorOptions();
        form.onsubmit = handleAddTask;
      }
      
      modal.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('task-modal').classList.remove('active');
    }
    
    function openShareModal() {
      if (currentTasks.length === 0) {
        showToast('ç›®å‰æ²’æœ‰ä»»å‹™å¯ä»¥åˆ†äº«');
        return;
      }
      document.getElementById('share-modal').classList.add('active');
    }
    
    function closeShareModal() {
      document.getElementById('share-modal').classList.remove('active');
      document.getElementById('download-loading').style.display = 'none';
    }
    
    async function downloadAsPNG() {
      const loadingEl = document.getElementById('download-loading');
      loadingEl.style.display = 'block';
      
      try {
        // æš«æ™‚éš±è—æ§åˆ¶æŒ‰éˆ•å’Œé›¢ç·šæç¤º
        const controls = document.querySelector('.controls');
        const offlineNotice = document.getElementById('offline-notice');
        const originalControlsDisplay = controls.style.display;
        const originalNoticeDisplay = offlineNotice.style.display;
        
        controls.style.display = 'none';
        offlineNotice.style.display = 'none';
        
        // ç­‰å¾… html2canvas è¼‰å…¥
        if (typeof html2canvas === 'undefined') {
          showToast('åœ–ç‰‡åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
          loadingEl.style.display = 'none';
          controls.style.display = originalControlsDisplay;
          offlineNotice.style.display = originalNoticeDisplay;
          return;
        }
        
        const timelineWrapper = document.querySelector('.timeline-wrapper');
        const canvas = await html2canvas(timelineWrapper, {
          backgroundColor: '#ffffff',
          scale: 2,
          logging: false,
          useCORS: true
        });
        
        // é‚„åŸé¡¯ç¤º
        controls.style.display = originalControlsDisplay;
        offlineNotice.style.display = originalNoticeDisplay;
        
        // ä¸‹è¼‰åœ–ç‰‡
        const imgData = canvas.toDataURL('image/png');
        let titleText = document.getElementById('timeline-title').textContent || 'æ™‚é–“è»¸';
        let yearText = document.getElementById('year-label').textContent.replace(' â–¼', '').trim() || '2025';
        
        // å¦‚æœä½¿ç”¨ SDK config
        if (window.elementSdk && window.elementSdk.config) {
          titleText = window.elementSdk.config.timeline_title || titleText;
          yearText = window.elementSdk.config.year_label || yearText;
        }
        
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `${titleText}_${yearText}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('åœ–ç‰‡å·²ä¸‹è¼‰ï¼');
        closeShareModal();
      } catch (error) {
        console.error('ä¸‹è¼‰åœ–ç‰‡å¤±æ•—:', error);
        showToast('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
        loadingEl.style.display = 'none';
        
        // é‚„åŸé¡¯ï¿½ï¿½ï¿½ï¿½ï¼ˆéŒ¯èª¤ï¿½ï¿½æ³ï¼‰
        const controls = document.querySelector('.controls');
        const offlineNotice = document.getElementById('offline-notice');
        if (controls) controls.style.display = '';
        if (offlineNotice) offlineNotice.style.display = '';
      }
    }
    
    async function downloadAsPDF() {
      const loadingEl = document.getElementById('download-loading');
      loadingEl.style.display = 'block';
      
      try {
        // æš«æ™‚éš±è—æ§åˆ¶æŒ‰éˆ•å’Œé›¢ç·šæç¤º
        const controls = document.querySelector('.controls');
        const offlineNotice = document.getElementById('offline-notice');
        const originalControlsDisplay = controls.style.display;
        const originalNoticeDisplay = offlineNotice.style.display;
        
        controls.style.display = 'none';
        offlineNotice.style.display = 'none';
        
        // ç­‰å¾…å‡½å¼åº«è¼‰å…¥
        if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
          showToast('PDF åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
          loadingEl.style.display = 'none';
          controls.style.display = originalControlsDisplay;
          offlineNotice.style.display = originalNoticeDisplay;
          return;
        }
        
        const timelineWrapper = document.querySelector('.timeline-wrapper');
        const canvas = await html2canvas(timelineWrapper, {
          backgroundColor: '#ffffff',
          scale: 2,
          logging: false,
          useCORS: true
        });
        
        // é‚„åŸé¡¯ç¤º
        controls.style.display = originalControlsDisplay;
        offlineNotice.style.display = originalNoticeDisplay;
        
        // å»ºï¿½ï¿½ï¿½ PDF
        const { jsPDF } = jspdf;
        const imgData = canvas.toDataURL('image/png');
        
        // è¨ˆï¿½ï¿½ï¿½ PDF å°ºå¯¸ï¼ˆA4 æ©«å‘ï¼‰
        const pdf = new jsPDF('landscape', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        
        const imgX = (pdfWidth - imgWidth * ratio) / 2;
        const imgY = (pdfHeight - imgHeight * ratio) / 2;
        
        pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
        
        // ä¸‹è¼‰ PDF
        let titleText = document.getElementById('timeline-title').textContent || 'æ™‚é–“è»¸';
        let yearText = document.getElementById('year-label').textContent.replace(' â–¼', '').trim() || '2025';
        
        // å¦‚æœä½¿ç”¨ SDK config
        if (window.elementSdk && window.elementSdk.config) {
          titleText = window.elementSdk.config.timeline_title || titleText;
          yearText = window.elementSdk.config.year_label || yearText;
        }
        
        pdf.save(`${titleText}_${yearText}.pdf`);
        
        showToast('PDF å·²ä¸‹è¼‰ï¼');
        closeShareModal();
      } catch (error) {
        console.error('ä¸‹è¼‰ PDF å¤±æ•—:', error);
        showToast('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
        loadingEl.style.display = 'none';
        
        // é‚„åŸé¡¯ç¤ºï¼ˆéŒ¯èª¤æƒ…æ³ï¼‰
        const controls = document.querySelector('.controls');
        const offlineNotice = document.getElementById('offline-notice');
        if (controls) controls.style.display = '';
        if (offlineNotice) offlineNotice.style.display = '';
      }
    }
    
    async function handleAddTask(e) {
      e.preventDefault();
      
      const taskName = document.getElementById('task-name-input').value;
      const startMonth = parseInt(document.getElementById('start-month').value);
      const endMonth = parseInt(document.getElementById('end-month').value);
      const category = document.getElementById('category-input').value;
      
      if (startMonth > endMonth) {
        showToast('é–‹å§‹æœˆä»½ä¸èƒ½å¤§æ–¼çµæŸæœˆä»½');
        return;
      }
      
      const loading = document.getElementById('loading');
      loading.classList.add('active');
      
      const maxOrder = currentTasks.length > 0 
        ? Math.max(...currentTasks.map(t => t.display_order || 0))
        : 0;
      
      if (window.dataSdk && !isOfflineMode) {
        const result = await window.dataSdk.create({
          task_name: taskName,
          start_month: startMonth,
          end_month: endMonth,
          color: selectedColor,
          category: category,
          display_order: maxOrder + 1
        });
        
        loading.classList.remove('active');
        
        if (result.isOk) {
          closeModal();
          showToast('ä»»å‹™å·²æ–°å¢');
        } else {
          showToast('æ–°å¢å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      } else {
        // é›¢ç·šæ¨¡å¼
        const newTask = {
          task_name: taskName,
          start_month: startMonth,
          end_month: endMonth,
          color: selectedColor,
          category: category,
          display_order: maxOrder + 1,
          __backendId: 'local_' + Date.now()
        };
        currentTasks.push(newTask);
        saveTasksOffline(currentTasks);
        renderTasks(currentTasks);
        loading.classList.remove('active');
        closeModal();
        showToast('ä»»å‹™å·²æ–°å¢');
      }
    }
    
    async function handleEditTask(e, task) {
      e.preventDefault();
      
      const taskName = document.getElementById('task-name-input').value;
      const startMonth = parseInt(document.getElementById('start-month').value);
      const endMonth = parseInt(document.getElementById('end-month').value);
      const category = document.getElementById('category-input').value;
      
      if (startMonth > endMonth) {
        showToast('é–‹å§‹æœˆä»½ä¸èƒ½å¤§æ–¼çµæŸæœˆä»½');
        return;
      }
      
      const loading = document.getElementById('loading');
      loading.classList.add('active');
      
      if (window.dataSdk && !isOfflineMode) {
        const result = await window.dataSdk.update({
          ...task,
          task_name: taskName,
          start_month: startMonth,
          end_month: endMonth,
          color: selectedColor,
          category: category
        });
        
        loading.classList.remove('active');
        
        if (result.isOk) {
          closeModal();
          showToast('ä»»å‹™å·²æ›´æ–°');
        } else {
          showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      } else {
        // é›¢ç·šæ¨¡å¼
        const index = currentTasks.findIndex(t => t.__backendId === task.__backendId);
        if (index !== -1) {
          currentTasks[index] = {
            ...task,
            task_name: taskName,
            start_month: startMonth,
            end_month: endMonth,
            color: selectedColor,
            category: category
          };
          saveTasksOffline(currentTasks);
          renderTasks(currentTasks);
        }
        loading.classList.remove('active');
        closeModal();
        showToast('ä»»å‹™å·²æ›´æ–°');
      }
    }
    
    function showDeleteConfirm(task) {
      taskToDelete = task;
      const confirmDialog = document.getElementById('delete-confirm');
      confirmDialog.classList.add('active');
    }
    
    function hideDeleteConfirm() {
      taskToDelete = null;
      const confirmDialog = document.getElementById('delete-confirm');
      confirmDialog.classList.remove('active');
    }
    
    async function confirmDelete() {
      if (!taskToDelete) return;
      
      const loading = document.getElementById('loading');
      loading.classList.add('active');
      
      if (window.dataSdk && !isOfflineMode) {
        const result = await window.dataSdk.delete(taskToDelete);
        
        loading.classList.remove('active');
        hideDeleteConfirm();
        
        if (result.isOk) {
          showToast('ä»»å‹™å·²åˆªé™¤');
        } else {
          showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      } else {
        // é›¢ç·šæ¨¡å¼
        const index = currentTasks.findIndex(t => t.__backendId === taskToDelete.__backendId);
        if (index !== -1) {
          currentTasks.splice(index, 1);
          saveTasksOffline(currentTasks);
          renderTasks(currentTasks);
        }
        loading.classList.remove('active');
        hideDeleteConfirm();
        showToast('ä»»å‹™å·²åˆªé™¤');
      }
    }
    
    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 3000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function renderTasks(tasks) {
      const grid = document.getElementById('tasks-grid');
      
      if (tasks.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p>å°šç„¡ä»»å‹™ï¼Œé»æ“Šã€Œæ–°å¢ä»»å‹™ã€é–‹å§‹å»ºç«‹ä½ çš„æ™‚é–“è»¸</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = '';
      
      tasks.forEach((task, rowIndex) => {
        const span = task.end_month - task.start_month + 1;
        
        const taskRow = document.createElement('div');
        taskRow.className = 'task-row';
        taskRow.setAttribute('data-row-index', rowIndex);
        taskRow.setAttribute('draggable', 'true');
        
        // æ•´åˆ—æ‹–æ›³äº‹ä»¶
        taskRow.addEventListener('dragstart', (e) => {
          draggedRowIndex = rowIndex;
          taskRow.classList.add('dragging-row');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        taskRow.addEventListener('dragend', (e) => {
          taskRow.classList.remove('dragging-row');
          document.querySelectorAll('.task-row').forEach(row => {
            row.classList.remove('drag-over-row');
          });
          draggedRowIndex = null;
        });
        
        taskRow.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedRowIndex !== null && draggedRowIndex !== rowIndex) {
            taskRow.classList.add('drag-over-row');
          }
        });
        
        taskRow.addEventListener('dragleave', (e) => {
          taskRow.classList.remove('drag-over-row');
        });
        
        taskRow.addEventListener('drop', async (e) => {
          e.preventDefault();
          taskRow.classList.remove('drag-over-row');
          
          if (draggedRowIndex !== null && draggedRowIndex !== rowIndex) {
            await reorderTasks(draggedRowIndex, rowIndex);
          }
        });
        
        const taskNameDiv = document.createElement('div');
        taskNameDiv.className = 'task-name';
        taskNameDiv.innerHTML = `<span>${task.task_name}${task.category ? `<br><small style="color: #999;">${task.category}</small>` : ''}</span>`;
        taskRow.appendChild(taskNameDiv);
        
        const timelineGrid = document.createElement('div');
        timelineGrid.className = 'timeline-grid';
        
        for (let i = 0; i < 12; i++) {
          const month = i + 1;
          const cell = document.createElement('div');
          
          if (month >= task.start_month && month <= task.end_month) {
            if (month === task.start_month) {
              cell.className = 'task-bar';
              cell.setAttribute('data-task-id', task.__backendId);
              cell.setAttribute('draggable', 'true');
              cell.style.background = task.color;
              cell.style.gridColumn = `span ${span}`;
              
              // å»ºç«‹å…§éƒ¨å®¹å™¨ä¾†é¡¯ç¤ºæœˆä»½åˆ†éš”ç·š
              const innerContainer = document.createElement('div');
              innerContainer.style.cssText = 'position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;';
              innerContainer.textContent = `${task.start_month}æœˆ - ${task.end_month}æœˆ`;
              
              // ç•«å‡ºæ¯å€‹æœˆçš„åˆ†éš”ç·š
              if (span > 1) {
                for (let m = 1; m < span; m++) {
                  const currentMonth = task.start_month + m - 1; // åˆ†éš”ç·šå·¦å´çš„æœˆä»½
                  const nextMonth = task.start_month + m; // åˆ†éš”ç·šå³å´çš„æœˆä»½
                  const divider = document.createElement('div');
                  const leftPercent = (m / span) * 100;
                  // åªæœ‰ç•¶åˆ†éš”ç·šæ˜¯6æœˆå’Œ7æœˆä¹‹é–“æ™‚æ‰é¡¯ç¤ºç²—ç·š
                  const isJunJulBorder = (currentMonth === 6 && nextMonth === 7);
                  divider.style.cssText = `
                    position: absolute;
                    left: ${leftPercent}%;
                    top: 0;
                    bottom: 0;
                    width: ${isJunJulBorder ? '2px' : '1px'};
                    background: rgba(255,255,255,0.3);
                  `;
                  innerContainer.appendChild(divider);
                }
              }
              
              cell.appendChild(innerContainer);
              
              // é˜»æ­¢å†’æ³¡åˆ°rowçš„æ‹–æ›³
              cell.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                draggedTask = task;
                cell.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
              });
              
              cell.addEventListener('dragend', (e) => {
                e.stopPropagation();
                cell.classList.remove('dragging');
                document.querySelectorAll('.drop-zone').forEach(zone => {
                  zone.classList.remove('drag-over');
                });
              });
              
              // å–®æ“Šç·¨è¼¯
              let clickTimer = null;
              cell.addEventListener('click', (e) => {
                e.stopPropagation();
                if (clickTimer) {
                  clearTimeout(clickTimer);
                  clickTimer = null;
                  return;
                }
                clickTimer = setTimeout(() => {
                  openModal(task);
                  clickTimer = null;
                }, 300);
              });
              
              // é›™æ“Šåˆªé™¤
              cell.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                if (clickTimer) {
                  clearTimeout(clickTimer);
                  clickTimer = null;
                }
                showDeleteConfirm(task);
              });
              
              timelineGrid.appendChild(cell);
            }
          } else {
            cell.className = 'drop-zone';
            cell.setAttribute('data-month', month);
            
            // æ‹–æ›³ç¶“é
            cell.addEventListener('dragover', (e) => {
              if (draggedTask) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                cell.classList.add('drag-over');
              }
            });
            
            // æ‹–æ›³é›¢é–‹
            cell.addEventListener('dragleave', (e) => {
              cell.classList.remove('drag-over');
            });
            
            // æ”¾ä¸‹
            cell.addEventListener('drop', async (e) => {
              if (draggedTask) {
                e.preventDefault();
                e.stopPropagation();
                cell.classList.remove('drag-over');
                
                const targetMonth = parseInt(cell.getAttribute('data-month'));
                const duration = draggedTask.end_month - draggedTask.start_month;
                const newStartMonth = targetMonth;
                const newEndMonth = newStartMonth + duration;
                
                if (newEndMonth > 12) {
                  showToast('ç„¡æ³•ç§»å‹•ï¼šçµæŸæœˆä»½è¶…é12æœˆ');
                  return;
                }
                
                const loading = document.getElementById('loading');
                loading.classList.add('active');
                
                if (window.dataSdk && !isOfflineMode) {
                  const result = await window.dataSdk.update({
                    ...draggedTask,
                    start_month: newStartMonth,
                    end_month: newEndMonth
                  });
                  
                  loading.classList.remove('active');
                  
                  if (result.isOk) {
                    showToast('ä»»å‹™æ™‚é–“å·²æ›´æ–°');
                  } else {
                    showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦');
                  }
                } else {
                  // é›¢ç·šæ¨¡å¼
                  const index = currentTasks.findIndex(t => t.__backendId === draggedTask.__backendId);
                  if (index !== -1) {
                    currentTasks[index] = {
                      ...draggedTask,
                      start_month: newStartMonth,
                      end_month: newEndMonth
                    };
                    saveTasksOffline(currentTasks);
                    renderTasks(currentTasks);
                  }
                  loading.classList.remove('active');
                  showToast('ä»»å‹™æ™‚é–“å·²æ›´æ–°');
                }
                
                draggedTask = null;
              }
            });
            
            timelineGrid.appendChild(cell);
          }
        }
        
        taskRow.appendChild(timelineGrid);
        grid.appendChild(taskRow);
      });
    }
    
    async function reorderTasks(fromIndex, toIndex) {
      const loading = document.getElementById('loading');
      loading.classList.add('active');
      
      const reorderedTasks = [...currentTasks];
      const [movedTask] = reorderedTasks.splice(fromIndex, 1);
      reorderedTasks.splice(toIndex, 0, movedTask);
      
      if (window.dataSdk && !isOfflineMode) {
        // æ›´æ–°æ‰€æœ‰ä»»å‹™çš„display_order
        for (let i = 0; i < reorderedTasks.length; i++) {
          const task = reorderedTasks[i];
          await window.dataSdk.update({
            ...task,
            display_order: i
          });
        }
      } else {
        // é›¢ç·šæ¨¡å¼
        for (let i = 0; i < reorderedTasks.length; i++) {
          reorderedTasks[i].display_order = i;
        }
        currentTasks = reorderedTasks;
        saveTasksOffline(currentTasks);
        renderTasks(currentTasks);
      }
      
      loading.classList.remove('active');
      showToast('é †åºå·²èª¿æ•´');
    }
    
    const dataHandler = {
      onDataChanged(data) {
        currentTasks = data.sort((a, b) => {
          const orderA = a.display_order !== undefined ? a.display_order : 999999;
          const orderB = b.display_order !== undefined ? b.display_order : 999999;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.start_month - b.start_month;
        });
        renderTasks(currentTasks);
      }
    };
    
    async function onConfigChange(config) {
      const titleElement = document.getElementById('timeline-title');
      const yearElement = document.getElementById('year-label');
      
      titleElement.textContent = config.timeline_title || defaultConfig.timeline_title;
      yearElement.textContent = (config.year_label || defaultConfig.year_label) + ' â–¼';
    }
    
    async function init() {
      // æª¢æŸ¥æ˜¯å¦ç‚ºé›¢ç·šæ¨¡å¼
      if (!window.dataSdk) {
        isOfflineMode = true;
        document.getElementById('offline-notice').style.display = 'block';
        // è¼‰å…¥é›¢ç·šè³‡æ–™
        currentTasks = loadTasksOffline();
        renderTasks(currentTasks);
      } else {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          isOfflineMode = true;
          document.getElementById('offline-notice').style.display = 'block';
          currentTasks = loadTasksOffline();
          renderTasks(currentTasks);
        }
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['timeline_title', config.timeline_title || defaultConfig.timeline_title],
            ['year_label', config.year_label || defaultConfig.year_label]
          ])
        });
      }
      
      renderColorOptions();
      
      document.getElementById('add-task-btn').addEventListener('click', () => openModal());
      document.getElementById('share-btn').addEventListener('click', openShareModal);
      document.getElementById('download-png').addEventListener('click', downloadAsPNG);
      document.getElementById('download-pdf').addEventListener('click', downloadAsPDF);
      
      document.getElementById('task-modal').addEventListener('click', (e) => {
        if (e.target.id === 'task-modal') {
          closeModal();
        }
      });
      
      document.getElementById('share-modal').addEventListener('click', (e) => {
        if (e.target.id === 'share-modal') {
          closeShareModal();
        }
      });
      
      document.getElementById('cancel-delete').addEventListener('click', hideDeleteConfirm);
      document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
    }
    
    // ç¢ºä¿é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a890fda95e14a46',t:'MTc2NDgyNzgwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
